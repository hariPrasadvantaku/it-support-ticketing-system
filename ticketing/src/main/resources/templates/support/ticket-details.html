<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Ticket Details</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<div class="container mt-4">

    <!-- Ticket Info -->
    <div class="card shadow mb-3">
        <div class="card-body">
            <h4 th:text="${ticket.title}"></h4>
            <p th:text="${ticket.description}"></p>

            <div class="d-flex justify-content-between align-items-center">
                <span class="badge bg-info fs-6" th:text="${ticket.status}"></span>

                <!-- STATUS UPDATE -->
                <form th:action="@{/support/tickets/update-status}" method="post" class="d-flex gap-2">
                    <input type="hidden" name="ticketId" th:value="${ticket.id}"/>

                    <select name="status" class="form-select form-select-sm">
                        <option th:each="s : ${statusMap[ticket.id]}"
                                th:value="${s}"
                                th:text="${s}">
                        </option>
                    </select>

                    <button class="btn btn-sm btn-success">Update</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Images -->
    <div class="card shadow mb-3"
         th:if="${images != null and !images.isEmpty()}">
        <div class="card-body">
            <h5>Attachments</h5>
            <div class="row g-3">
                <div class="col-md-3" th:each="img : ${images}">
                    <img th:src="@{'/images/' + ${img.id}}"
                         class="img-fluid rounded border"
                         style="height:180px; object-fit:cover;">
                </div>
            </div>
        </div>
    </div>

    <!-- Comments -->
    <div class="card shadow mb-3">
        <div class="card-body">
            <h5>Comments</h5>

            <div class="border p-2 mb-2" th:each="c : ${comments}">
                <div class="d-flex justify-content-between">
                    <b th:text="${c.user.username}"></b>
                    <small class="text-muted"
                           th:text="${#temporals.format(c.createdAt,'dd MMM yyyy HH:mm')}">
                    </small>
                </div>
                <p th:text="${c.content}"></p>
            </div>

            <!-- COMMENT FORM -->
            <form th:action="@{'/support/tickets/' + ${ticket.id} + '/comment'}"
                  method="post">
                <textarea name="comment"
                          class="form-control mb-2"
                          required></textarea>
                <button class="btn btn-primary">Send</button>
            </form>
        </div>
    </div>

    <!-- STATUS HISTORY -->
    <div class="card shadow">
        <div class="card-body">
            <h5>Status History</h5>
            <ul class="list-group">
                <li class="list-group-item"
                    th:each="h : ${statusHistory}">

                    <div class="d-flex justify-content-between">
                        <span>
                            <b th:text="${h.oldStatus}"></b>
                            â†’
                            <b th:text="${h.newStatus}"></b>
                            by <span th:text="${h.changedBy.username}"></span>
                        </span>

                        <small class="text-muted"
                               th:text="${#temporals.format(h.changedAt,'dd MMM yyyy HH:mm')}">
                        </small>
                    </div>

                </li>
            </ul>
        </div>
    </div>

</div>
</body>
</html>
